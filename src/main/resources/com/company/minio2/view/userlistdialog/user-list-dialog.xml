<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<view xmlns="http://jmix.io/schema/flowui/view"
      title="User List Dialog">
    <data>
        <collection id="permissionsDc" class="com.company.minio2.entity.Permission">
            <fetchPlan extends="_base">
                <property name="permissionType"/>
                <property name="user" fetchPlan="_base"/>
                <property name="roleCode"/>
            </fetchPlan>
            <loader id="permissionsDl">
                <query>
                    <![CDATA[
        select p from Permission p
        where p.filePath = :filePath
          and (
               (:user is null or p.user = :user)
               or (:roleCode is null or p.roleCode = :roleCode)
          )
    ]]>
                </query>
            </loader>
        </collection>
        <collection id="usersDc"
                    class="com.company.minio2.entity.User">
            <fetchPlan extends="_base">
                <property name="username"/>
            </fetchPlan>
            <loader id="usersDl" readOnly="true">
                <query>
                    <![CDATA[
        select u from User u
        where u not in (
            select p.user from Permission p
            where p.filePath = :filePath
              and p.user is not null
        )
        order by u.username
    ]]>
                </query>
            </loader>
        </collection>

        <collection id="objectDtosDc"
                    class="com.company.minio2.entity.ObjectDTO">
        </collection>
        <collection id="rolesDc"
                    class="io.jmix.securitydata.entity.ResourceRoleEntity">
            <fetchPlan extends="_base">
                <property name="code"/>
                <property name="name"/>
            </fetchPlan>
            <loader id="rolesDl">
                <query>
                    <![CDATA[
                select r from sec_ResourceRoleEntity r
                where r.code not in (
                    select p.roleCode from Permission p
                    where p.filePath = :filePath
                      and p.roleCode is not null
                )
                order by r.name
            ]]>
                </query>
            </loader>
        </collection>
    </data>
    <layout height="500px" width="500px">
        <textArea id="fileKeyArea" label="Object key: " readOnly="true" width="100%"/>
        <hbox spacing="true">
            <button id="usersBtn" text="Users"/>
            <button id="rolesBtn" text="Roles"/>
        </hbox>
        <vbox spacing="true" width="100%" height="400px" >
            <dataGrid id="objectDTODataGrid" dataContainer="objectDtosDc" width="100%" height="200px">
                <columns>
                    <column property="name" header="Name"/>
                    <column property="type" header="Type"/>
                </columns>
            </dataGrid>
        </vbox>
        <hbox spacing="true">
            <button id="applyBtn" text="Apply"/>
        </hbox>
    </layout>
</view>